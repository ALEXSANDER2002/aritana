{% extends 'embarcacoes/base.html' %}
{% load static %}

{% block title %}Dashboard - ARITANA{% endblock %}

{% block content %}
<!-- Dashboard Principal -->
<div class="dashboard-container">
        <div class="row">
            <!-- Estat√≠sticas Premium -->
            <div class="col-12 mb-5">
                <div class="row g-4">
                    <div class="col-lg-4 col-md-6">
                        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.1s;">
                            <div class="stat-number stat-total">{{ total_embarcacoes }}</div>
                            <div class="stat-label">
                                <i class="fas fa-ship me-2"></i>Total de Embarca√ß√µes
                            </div>
                            <div class="stat-description">Monitoramento completo da regi√£o</div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.2s;">
                            <div class="stat-number stat-legal">{{ embarcacoes_legais }}</div>
                            <div class="stat-label">
                                <i class="fas fa-check-circle me-2"></i>Embarcaciones Legais
                            </div>
                            <div class="stat-description">Em conformidade com a legisla√ß√£o</div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="stat-card animate-fade-in-up" style="animation-delay: 0.3s;">
                            <div class="stat-number stat-illegal">{{ embarcacoes_ilegais }}</div>
                            <div class="stat-label">
                                <i class="fas fa-exclamation-triangle me-2"></i>Embarcaciones Ilegais
                            </div>
                            <div class="stat-description">Requerem aten√ß√£o das autoridades</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Premium -->
            <div class="col-12 mb-5">
                <div class="card animate-fade-in-up" style="animation-delay: 0.4s;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cloud-upload-alt me-2"></i>
                            An√°lise Inteligente de Embarca√ß√µes
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            <i class="fas fa-brain me-2"></i>
                            Carregue uma imagem da embarca√ß√£o para an√°lise autom√°tica de legalidade usando intelig√™ncia artificial
                        </p>
                        
                        <div class="upload-area-premium" id="uploadArea" onclick="redirecionarParaUpload()">
                            <div class="upload-placeholder">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h6 class="upload-title">Clique aqui para fazer upload de imagem</h6>
                                <p class="upload-subtitle">Voc√™ ser√° redirecionado para a p√°gina de upload</p>
                                <div class="upload-info">
                                    <span class="badge badge-info me-2">PNG</span>
                                    <span class="badge badge-info me-2">JPG</span>
                                    <span class="badge badge-info me-2">JPEG</span>
                                    <span class="badge badge-warning">M√°x. 20MB</span>
                                </div>
                            </div>
                        </div>
                            
                    </div>
                </div>
            </div>

            <!-- Mapa de Localiza√ß√µes - Largura Completa -->
            <div class="col-12 mb-4">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marked-alt"></i> Mapa de Localiza√ß√µes</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Visualize as embarca√ß√µes registradas na regi√£o de Bel√©m</p>
                        <div id="map" class="map-container mb-3"></div>
                        <div class="text-center">
                            <div class="legend-item">
                                <span class="legend-color legend-legal"></span>
                                <span>Embarca√ß√£o Legal</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color legend-illegal"></span>
                                <span>Alerta Ilegal</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos e Estat√≠sticas -->
        <div class="row">
            <!-- Primeira linha: Gr√°fico de Legalidade e Regional -->
            <div class="col-12 col-lg-5 col-xl-4 mb-4">
                <div class="card fade-in h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Distribui√ß√£o de Legalidade</h5>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <p class="text-muted small mb-3">Propor√ß√£o entre embarca√ß√µes legais e ilegais identificadas</p>
                        <div class="chart-container flex-grow-1">
                            <canvas id="legalityChart"></canvas>
                        </div>
                        <div class="text-center mt-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="stat-number stat-legal" style="font-size: 1.8rem;">{{ embarcacoes_legais }}</div>
                                    <small class="text-muted d-block">Legais</small>
                                </div>
                                <div class="col-6">
                                    <div class="stat-number stat-illegal" style="font-size: 1.8rem;">{{ embarcacoes_ilegais }}</div>
                                    <small class="text-muted d-block">Ilegais</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-7 col-xl-8 mb-4">
                <div class="card fade-in h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> An√°lises por Regi√£o</h5>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <p class="text-muted small mb-3">Distribui√ß√£o de an√°lises legais e ilegais por regi√£o</p>
                        <div class="chart-container flex-grow-1">
                            <canvas id="regionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico Temporal removido para simplificar interface -->
    </div>
</div>
<!-- Fim Dashboard Principal -->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar funcionalidades b√°sicas imediatamente
    initializeUpload();
    
    // Carregar componentes pesados de forma ass√≠ncrona
    loadHeavyComponents();
});

// Carregar componentes pesados de forma ass√≠ncrona
function loadHeavyComponents() {
    // Mostrar indicador de carregamento
    showLoadingIndicator();
    
    // Carregar mapa com delay
    setTimeout(() => {
        loadLeaflet().then(() => {
            initializeMap();
        });
    }, 500);
    
    // Carregar gr√°ficos com delay maior
    setTimeout(() => {
        loadChartJS().then(() => {
            initializeCharts();
            hideLoadingIndicator();
        });
    }, 1000);
}

// Indicador de carregamento
function showLoadingIndicator() {
    const loadingHtml = `
        <div id="loading-indicator" class="text-center py-4">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="text-muted mt-2">Carregando dados...</p>
        </div>
    `;
    
    // Adicionar ao mapa
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        mapContainer.innerHTML = loadingHtml;
    }
    
    // Adicionar aos gr√°ficos
    const chartsContainer = document.querySelector('#principal .row:last-child');
    if (chartsContainer) {
        chartsContainer.insertAdjacentHTML('beforeend', loadingHtml);
    }
}

function hideLoadingIndicator() {
    const indicators = document.querySelectorAll('#loading-indicator');
    indicators.forEach(indicator => indicator.remove());
}

// Redirecionar para p√°gina de upload
function redirecionarParaUpload() {
    window.location.href = '/upload-page/';
}

// Upload de Arquivo
function initializeUpload() {
    // N√£o precisa mais de l√≥gica complexa - apenas redireciona
    console.log('Upload configurado para redirecionar para /upload-page/');
    
    function handleFileSelection(file) {
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione apenas arquivos de imagem.');
            return;
        }
        
        if (file.size > 20 * 1024 * 1024) {
            alert('Arquivo muito grande. M√°ximo 20MB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadArea.innerHTML = `
                <div class="text-center">
                    <img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 10px;">
                    <p class="text-success mt-2"><i class="fas fa-check-circle"></i> Imagem selecionada: ${file.name}</p>
                    <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                </div>
            `;
            uploadDetails.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

// Inicializar Mapa
function initializeMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;
    
    // Limpar indicador de carregamento
    mapContainer.innerHTML = '';
    
    // Criar mapa com coordenadas padr√£o (ser√° ajustado quando os dados chegarem)
    const map = L.map('map').setView([-1.4558, -48.5044], 10); // Bel√©m, PA
    
    // Usar tiles mais leves para melhor performance
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18,
        maxNativeZoom: 17
    }).addTo(map);
    
    // Carregar dados das embarca√ß√µes com timeout
    const fetchPromise = fetch('{% url "dados_mapa_json" %}');
    const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout')), 5000)
    );
    
    Promise.race([fetchPromise, timeoutPromise])
        .then(response => response.json())
        .then(data => {
            if (data.embarcacoes && data.embarcacoes.length > 0) {
                // Limitar n√∫mero de marcadores para melhor performance
                const maxMarkers = 50;
                const embarcacoes = data.embarcacoes.slice(0, maxMarkers);
                
                // Calcular limites das coordenadas para ajustar o mapa
                const latitudes = embarcacoes.map(e => parseFloat(e.latitude));
                const longitudes = embarcacoes.map(e => parseFloat(e.longitude));
                
                const minLat = Math.min(...latitudes);
                const maxLat = Math.max(...latitudes);
                const minLng = Math.min(...longitudes);
                const maxLng = Math.max(...longitudes);
                
                // Criar bounds para ajustar o zoom
                const bounds = [[minLat, minLng], [maxLat, maxLng]];
                
                // Ajustar o mapa para mostrar todos os pontos
                map.fitBounds(bounds, {padding: [20, 20]});
                
                // Adicionar marcadores em batch para melhor performance
                addMarkersInBatch(map, embarcacoes);
                
                console.log(`Mapa carregado com ${embarcacoes.length} embarca√ß√µes`);
            }
            
            // Adicionar legenda
            addMapLegend(map);
        })
        .catch(error => {
            console.error('Erro ao carregar dados do mapa:', error);
            // Mostrar mensagem de erro no mapa
            mapContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted">Erro ao carregar dados do mapa</h5>
                    <p class="text-muted">Tente recarregar a p√°gina</p>
                </div>
            `;
        });
}

// Adicionar marcadores em batch para melhor performance
function addMarkersInBatch(map, embarcacoes) {
    const batchSize = 10;
    let index = 0;
    
    function addBatch() {
        const endIndex = Math.min(index + batchSize, embarcacoes.length);
        
        for (let i = index; i < endIndex; i++) {
            const embarcacao = embarcacoes[i];
            addMarker(map, embarcacao);
        }
        
        index = endIndex;
        
        if (index < embarcacoes.length) {
            // Usar requestAnimationFrame para n√£o bloquear a UI
            requestAnimationFrame(addBatch);
        }
    }
    
    addBatch();
}

// Adicionar marcador individual
function addMarker(map, embarcacao) {
    let color, icon;
    
    switch(embarcacao.classificacao.toLowerCase()) {
        case 'legal':
            color = '#4caf50';
            icon = '‚úÖ';
            break;
        case 'ilegal':
            color = '#f44336';
            icon = '‚ö†Ô∏è';
            break;
        default:
            color = '#757575';
            icon = '‚ùì';
    }
    
    // Criar marcador personalizado
    const marker = L.circleMarker([embarcacao.latitude, embarcacao.longitude], {
        color: color,
        fillColor: color,
        fillOpacity: 0.8,
        radius: 10,
        weight: 2
    }).addTo(map);
    
    // Adicionar popup simplificado
    marker.bindPopup(`
        <div style="min-width: 180px; text-align: center;">
            <div style="font-size: 20px; margin-bottom: 5px;">${icon}</div>
            <h6 style="margin: 0 0 5px 0; color: #333; font-size: 14px;">${embarcacao.localidade}</h6>
            <div style="background: ${color}; color: white; padding: 3px 6px; border-radius: 10px; margin: 3px 0; font-size: 11px;">
                ${embarcacao.classificacao}
            </div>
            <div style="margin: 3px 0; font-size: 11px; color: #666;">
                <strong>Regi√£o:</strong> ${embarcacao.regiao}
            </div>
        </div>
    `);
}

// Adicionar legenda do mapa
function addMapLegend(map) {
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        div.style.backgroundColor = 'white';
        div.style.padding = '8px';
        div.style.borderRadius = '5px';
        div.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        div.innerHTML = `
            <h6 style="margin: 0 0 8px 0; font-weight: bold; font-size: 12px;">Legenda</h6>
            <div style="margin-bottom: 3px;">
                <span style="color: #4caf50; font-size: 14px;">‚úÖ</span> 
                <span style="margin-left: 5px; font-size: 11px;">Legal</span>
            </div>
            <div style="margin-bottom: 3px;">
                <span style="color: #f44336; font-size: 14px;">‚ö†Ô∏è</span> 
                <span style="margin-left: 5px; font-size: 11px;">Ilegal</span>
            </div>
            <div style="margin-bottom: 0;">
                <span style="color: #757575; font-size: 14px;">‚ùì</span> 
                <span style="margin-left: 5px; font-size: 11px;">Desconhecido</span>
            </div>
        `;
        return div;
    };
    legend.addTo(map);
}

// Inicializar Gr√°ficos
function initializeCharts() {
    const chartsContainer = document.querySelector('#principal .row:last-child');
    if (!chartsContainer) return;
    
    // Limpar indicador de carregamento
    const loadingIndicator = chartsContainer.querySelector('#loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.remove();
    }
    
    // Timeout para carregamento dos gr√°ficos
    const fetchPromise = fetch('{% url "dados_graficos_json" %}');
    const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout')), 5000)
    );
    
    Promise.race([fetchPromise, timeoutPromise])
        .then(response => response.json())
        .then(data => {
            // Criar gr√°ficos com anima√ß√£o suave
            createLegalityChart(data.legalidade);
            
            if (data.regional.meses.length > 0) {
                createRegionalChart(data.regional);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar dados dos gr√°ficos:', error);
            // Mostrar mensagem de erro
            const chartContainers = document.querySelectorAll('#legalityChart, #regionChart');
            chartContainers.forEach(container => {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-2x text-muted mb-2"></i>
                        <p class="text-muted small">Erro ao carregar gr√°fico</p>
                    </div>
                `;
            });
        });
}

// Criar gr√°fico de legalidade
function createLegalityChart(legalidadeData) {
    const ctx = document.getElementById('legalityChart');
    if (!ctx) return;
    
    new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Embarca√ß√µes Legais', 'Embarca√ß√µes Ilegais'],
            datasets: [{
                data: [legalidadeData.legais, legalidadeData.ilegais],
                backgroundColor: ['rgba(74, 139, 122, 0.8)', 'rgba(220, 38, 38, 0.8)'], // Verde √°gua e vermelho da logo ARITANA
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Criar gr√°fico regional
function createRegionalChart(regionalData) {
    const ctx = document.getElementById('regionChart');
    if (!ctx) return;
    
    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: regionalData.meses,
            datasets: [
                {
                    label: 'Legais',
                    data: regionalData.legais,
                    backgroundColor: 'rgba(74, 139, 122, 0.8)', // Verde √°gua da logo ARITANA
                    borderRadius: 4
                },
                {
                    label: 'Ilegais',
                    data: regionalData.ilegais,
                    backgroundColor: 'rgba(220, 38, 38, 0.8)', // Vermelho da logo ARITANA
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Funcionalidade das Abas
function initializeTabs() {
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('click', function (e) {
            // Remover classe active de todos os bot√µes
            tabs.forEach(t => {
                t.classList.remove('active', 'btn-success');
                t.classList.add('btn-outline-primary', 'btn-outline-success');
            });
            
            // Adicionar classe active no bot√£o clicado
            this.classList.remove('btn-outline-primary', 'btn-outline-success');
            this.classList.add('active', 'btn-success');
            
            const target = this.getAttribute('data-bs-target');
            console.log(`Aba ativada: ${target}`);
            
            // Feedback visual
            showTabNotification(target);
        });
    });
}

function showTabNotification(target) {
    let message;
    switch(target) {
        case '#principal':
            message = 'üìä Visualizando dados principais';
            break;
        case '#regional':
            message = 'üè¢ Dados regionais das embarca√ß√µes';
            break;
        case '#ambiental':
            message = 'üåø Informa√ß√µes ambientais legais';
            break;
    }
    
    // Criar toast de notifica√ß√£o
    const toastHtml = `
        <div class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Adicionar toast ao DOM
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.innerHTML = toastHtml;
    const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
    toast.show();
}
</script>
{% endblock %}
