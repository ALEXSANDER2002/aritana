{% extends 'embarcacoes/base.html' %}
{% load static %}

{% block title %}Dashboard - ARITANA{% endblock %}

{% block content %}
    {% include 'embarcacoes/partials/dashboard_main.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar funcionalidades b√°sicas imediatamente
    initializeUpload();
    
    // Carregar componentes pesados de forma ass√≠ncrona
    loadHeavyComponents();
});

// Carregar componentes pesados de forma ass√≠ncrona
function loadHeavyComponents() {
    // Mostrar indicador de carregamento
    showLoadingIndicator();
    
    // Carregar mapa com delay
    setTimeout(() => {
        console.log('üîÑ Iniciando carregamento do mapa...');
        
        // Garantir que o container do mapa tenha altura
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            if (!mapContainer.style.height || mapContainer.offsetHeight === 0) {
                mapContainer.style.height = '500px';
                mapContainer.style.minHeight = '400px';
                console.log('üìè Altura do container do mapa definida');
            }
        }
        
        // Verificar se loadLeaflet est√° dispon√≠vel (do base.html)
        const loadLeafletFn = window.loadLeaflet || loadLeaflet;
        if (typeof loadLeafletFn === 'function') {
            console.log('üìö Carregando biblioteca Leaflet...');
            loadLeafletFn()
                .then(() => {
                    console.log('‚úÖ Leaflet carregado, inicializando mapa...');
                    // Aguardar um pouco para garantir que tudo est√° pronto
                    setTimeout(() => {
                        // Verificar se initializeMap est√° dispon√≠vel (do dashboard.js)
                        if (typeof window.initializeMap === 'function') {
                            window.initializeMap();
                        } else if (typeof initializeMap === 'function') {
                            initializeMap();
                        } else {
                            console.error('‚ùå initializeMap n√£o est√° dispon√≠vel');
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('‚ùå Erro ao carregar Leaflet:', error);
                    // Tentar inicializar mesmo assim - pode funcionar se j√° estiver carregado
                    if (typeof L !== 'undefined' && typeof window.initializeMap === 'function') {
                        console.log('üîÑ Tentando inicializar mapa mesmo com erro no carregamento...');
                        setTimeout(() => window.initializeMap(), 200);
                    }
                });
        } else {
            console.warn('‚ö†Ô∏è loadLeaflet n√£o est√° dispon√≠vel, tentando inicializar mapa diretamente...');
            // Tentar inicializar diretamente - pode funcionar se Leaflet j√° estiver carregado
            if (typeof L !== 'undefined') {
                if (typeof window.initializeMap === 'function') {
                    setTimeout(() => window.initializeMap(), 200);
                } else {
                    console.error('‚ùå initializeMap n√£o est√° dispon√≠vel e Leaflet j√° est√° carregado');
                }
            } else {
                console.error('‚ùå Leaflet n√£o est√° dispon√≠vel e loadLeaflet tamb√©m n√£o');
            }
        }
    }, 500);
    
    // Carregar gr√°ficos com delay maior
    setTimeout(() => {
        const loadChartJSFn = window.loadChartJS || loadChartJS;
        if (typeof loadChartJSFn === 'function') {
            loadChartJSFn()
                .then(() => {
                    if (typeof window.initializeCharts === 'function') {
                        window.initializeCharts();
                    } else if (typeof initializeCharts === 'function') {
            initializeCharts();
                    }
                    hideLoadingIndicator();
                })
                .catch(error => {
                    console.error('Erro ao carregar Chart.js:', error);
                    hideLoadingIndicator();
                });
        } else {
            hideLoadingIndicator();
        }
    }, 1000);
}

// Indicador de carregamento
function showLoadingIndicator() {
    const loadingHtml = `
        <div id="loading-indicator" class="text-center py-4">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="text-muted mt-2">Carregando dados...</p>
        </div>
    `;
    
    // Adicionar ao mapa
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        mapContainer.innerHTML = loadingHtml;
    }
    
    // Adicionar aos gr√°ficos
    const chartsContainer = document.getElementById('dashboard-charts');
    if (chartsContainer) {
        chartsContainer.insertAdjacentHTML('beforeend', loadingHtml);
    }
}

function hideLoadingIndicator() {
    const indicators = document.querySelectorAll('#loading-indicator');
    indicators.forEach(indicator => indicator.remove());
}

// Redirecionar para p√°gina de upload
function redirecionarParaUpload() {
    window.location.href = '/upload-page/';
}

// Upload de Arquivo
function initializeUpload() {
    console.log('Upload configurado para redirecionar para /upload-page/');
}

// Inicializar Mapa
function initializeMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;
    
    mapContainer.innerHTML = '';
    
    const map = L.map('map').setView([-1.4558, -48.5044], 10);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18,
        maxNativeZoom: 17
    }).addTo(map);
    
    // Usar URL absoluta para funcionar em produ√ß√£o
    const apiUrl = window.location.origin + '{% url "dados_mapa_json" %}';
    const fetchPromise = fetch(apiUrl);
    const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout ao carregar dados do mapa')), 10000)
    );
    
    Promise.race([fetchPromise, timeoutPromise])
        .then(response => response.json())
        .then(data => {
            if (data.embarcacoes && data.embarcacoes.length > 0) {
                const maxMarkers = 50;
                const embarcacoes = data.embarcacoes.slice(0, maxMarkers);
                
                const latitudes = embarcacoes.map(e => parseFloat(e.latitude));
                const longitudes = embarcacoes.map(e => parseFloat(e.longitude));
                
                const minLat = Math.min(...latitudes);
                const maxLat = Math.max(...latitudes);
                const minLng = Math.min(...longitudes);
                const maxLng = Math.max(...longitudes);
                
                const bounds = [[minLat, minLng], [maxLat, maxLng]];
                map.fitBounds(bounds, {padding: [20, 20]});
                
                addMarkersInBatch(map, embarcacoes);
            }
            
            addMapLegend(map);
        })
        .catch(error => {
            console.error('Erro ao carregar dados do mapa:', error);
            mapContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted">Erro ao carregar dados do mapa</h5>
                    <p class="text-muted">Tente recarregar a p√°gina</p>
                </div>
            `;
        });
}

function addMarkersInBatch(map, embarcacoes) {
    const batchSize = 10;
    let index = 0;
    
    function addBatch() {
        const endIndex = Math.min(index + batchSize, embarcacoes.length);
        
        for (let i = index; i < endIndex; i++) {
            const embarcacao = embarcacoes[i];
            addMarker(map, embarcacao);
        }
        
        index = endIndex;
        
        if (index < embarcacoes.length) {
            requestAnimationFrame(addBatch);
        }
    }
    
    addBatch();
}

function addMarker(map, embarcacao) {
    let color, icon;
    
    switch(embarcacao.classificacao.toLowerCase()) {
        case 'legal':
            color = '#4caf50';
            icon = '‚úÖ';
            break;
        case 'ilegal':
            color = '#f44336';
            icon = '‚ö†Ô∏è';
            break;
        default:
            color = '#757575';
            icon = '‚ùì';
    }
    
    const marker = L.circleMarker([embarcacao.latitude, embarcacao.longitude], {
        color: color,
        fillColor: color,
        fillOpacity: 0.8,
        radius: 10,
        weight: 2
    }).addTo(map);
    
    marker.bindPopup(`
        <div style="min-width: 180px; text-align: center;">
            <div style="font-size: 20px; margin-bottom: 5px;">${icon}</div>
            <h6 style="margin: 0 0 5px 0; color: #333; font-size: 14px;">${embarcacao.localidade}</h6>
            <div style="background: ${color}; color: white; padding: 3px 6px; border-radius: 10px; margin: 3px 0; font-size: 11px;">
                ${embarcacao.classificacao}
            </div>
            <div style="margin: 3px 0; font-size: 11px; color: #666;">
                <strong>Regi√£o:</strong> ${embarcacao.regiao}
            </div>
        </div>
    `);
}

function addMapLegend(map) {
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'info legend');
        div.style.backgroundColor = 'white';
        div.style.padding = '8px';
        div.style.borderRadius = '5px';
        div.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        div.innerHTML = `
            <h6 style="margin: 0 0 8px 0; font-weight: bold; font-size: 12px;">Legenda</h6>
            <div style="margin-bottom: 3px;">
                <span style="color: #4caf50; font-size: 14px;">‚úÖ</span> 
                <span style="margin-left: 5px; font-size: 11px;">Legal</span>
            </div>
            <div style="margin-bottom: 3px;">
                <span style="color: #f44336; font-size: 14px;">‚ö†Ô∏è</span> 
                <span style="margin-left: 5px; font-size: 11px;">Ilegal</span>
            </div>
            <div style="margin-bottom: 0;">
                <span style="color: #757575; font-size: 14px;">‚ùì</span> 
                <span style="margin-left: 5px; font-size: 11px;">Desconhecido</span>
            </div>
        `;
        return div;
    };
    legend.addTo(map);
}

function initializeCharts() {
    const chartsContainer = document.getElementById('dashboard-charts');
    if (!chartsContainer) return;
    
    const loadingIndicator = chartsContainer.querySelector('#loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.remove();
    }
    
    const fetchPromise = fetch('{% url "dados_graficos_json" %}');
    const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout')), 5000)
    );
    
    Promise.race([fetchPromise, timeoutPromise])
        .then(response => response.json())
        .then(data => {
            createLegalityChart(data.legalidade);
            
            if (data.regional.meses.length > 0) {
                createRegionalChart(data.regional);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar dados dos gr√°ficos:', error);
            const chartContainers = document.querySelectorAll('#legalityChart, #regionChart');
            chartContainers.forEach(container => {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-2x text-muted mb-2"></i>
                        <p class="text-muted small">Erro ao carregar gr√°fico</p>
                    </div>
                `;
            });
        });
}

function createLegalityChart(legalidadeData) {
    const ctx = document.getElementById('legalityChart');
    if (!ctx) return;
    
    new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Embarca√ß√µes Legais', 'Embarca√ß√µes Ilegais'],
            datasets: [{
                data: [legalidadeData.legais, legalidadeData.ilegais],
                backgroundColor: ['rgba(74, 139, 122, 0.8)', 'rgba(220, 38, 38, 0.8)'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createRegionalChart(regionalData) {
    const ctx = document.getElementById('regionChart');
    if (!ctx) return;
    
    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: regionalData.meses,
            datasets: [
                {
                    label: 'Legais',
                    data: regionalData.legais,
                    backgroundColor: 'rgba(74, 139, 122, 0.8)',
                    borderRadius: 4
                },
                {
                    label: 'Ilegais',
                    data: regionalData.ilegais,
                    backgroundColor: 'rgba(220, 38, 38, 0.8)',
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function initializeTabs() {
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('click', function () {
            tabs.forEach(t => {
                t.classList.remove('active', 'btn-success');
                t.classList.add('btn-outline-primary', 'btn-outline-success');
            });
            
            this.classList.remove('btn-outline-primary', 'btn-outline-success');
            this.classList.add('active', 'btn-success');
            
            const target = this.getAttribute('data-bs-target');
            showTabNotification(target);
        });
    });
}

function showTabNotification(target) {
    let message;
    switch(target) {
        case '#principal':
            message = 'üìä Visualizando dados principais';
            break;
        case '#regional':
            message = 'üè¢ Dados regionais das embarca√ß√µes';
            break;
        case '#ambiental':
            message = 'üåø Informa√ß√µes ambientais legais';
            break;
        default:
            message = '';
    }
    
    if (!message) return;
    
    const toastHtml = `
        <div class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.innerHTML = toastHtml;
    const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
    toast.show();
}

function loadLeaflet() {
    if (window.L) {
        console.log('‚úÖ Leaflet j√° est√° carregado');
        return Promise.resolve();
    }
    return new Promise((resolve, reject) => {
        console.log('üîÑ Carregando Leaflet...');
        
        // Verificar se o CSS j√° foi carregado
        const existingCSS = document.querySelector('link[href*="leaflet.css"]');
        if (!existingCSS) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
            link.crossOrigin = 'anonymous';
            link.onerror = function() {
                console.warn('‚ö†Ô∏è Erro ao carregar CSS, tentando fallback...');
                const fallbackLink = document.createElement('link');
                fallbackLink.rel = 'stylesheet';
                fallbackLink.href = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css';
                fallbackLink.crossOrigin = 'anonymous';
                document.head.appendChild(fallbackLink);
            };
            document.head.appendChild(link);
        }
        
        const existingScript = document.querySelector('script[data-leaflet], script[src*="leaflet.js"]');
        if (existingScript) {
            if (typeof L !== 'undefined') {
                resolve();
                return;
            }
            existingScript.addEventListener('load', () => {
                console.log('‚úÖ Leaflet carregado via script existente');
                setTimeout(resolve, 200);
            });
            existingScript.addEventListener('error', (error) => {
                console.error('‚ùå Erro no script existente:', error);
                reject(error);
            });
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        script.crossOrigin = 'anonymous';
        script.async = true;
        script.dataset.leaflet = 'true';
        
        const timeout = setTimeout(() => {
            if (typeof L === 'undefined') {
                console.error('‚ùå Timeout ao carregar Leaflet');
                reject(new Error('Timeout ao carregar Leaflet'));
            }
        }, 10000);
        
        script.onload = function() {
            clearTimeout(timeout);
            console.log('‚úÖ Leaflet JS carregado com sucesso');
            if (typeof L !== 'undefined') {
                setTimeout(resolve, 200);
            } else {
                console.error('‚ùå Leaflet carregado mas L n√£o est√° dispon√≠vel');
                reject(new Error('Leaflet carregado mas L n√£o est√° dispon√≠vel'));
            }
        };
        
        script.onerror = function(error) {
            clearTimeout(timeout);
            console.error('‚ùå Erro ao carregar Leaflet, tentando fallback...', error);
            // Tentar fallback
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
            fallbackScript.crossOrigin = 'anonymous';
            fallbackScript.async = true;
            fallbackScript.onload = function() {
                if (typeof L !== 'undefined') {
                    console.log('‚úÖ Leaflet carregado via fallback');
                    setTimeout(resolve, 200);
                } else {
                    reject(new Error('Fallback tamb√©m falhou'));
                }
            };
            fallbackScript.onerror = function() {
                reject(new Error('Todos os CDNs falharam'));
            };
            document.head.appendChild(fallbackScript);
        };
        
        document.head.appendChild(script);
    });
}

function loadChartJS() {
    if (window.Chart) {
        return Promise.resolve();
    }
    return new Promise((resolve, reject) => {
        const existingScript = document.querySelector('script[data-chartjs]');
        if (existingScript) {
            existingScript.addEventListener('load', resolve);
            existingScript.addEventListener('error', reject);
            return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js';
        script.defer = true;
        script.dataset.chartjs = 'true';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}
</script>
{% endblock %}

