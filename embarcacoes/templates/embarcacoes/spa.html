{% extends 'embarcacoes/base.html' %}
{% load static %}

{% block title %}ARITANA - Sistema de Monitoramento{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        min-height: calc(100vh - 200px);
        display: none;
    }
    
    .page-container.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .nav-link.active {
        background-color: var(--secondary-color) !important;
        color: white !important;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-spinner {
        text-align: center;
        color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner-border text-success mb-3" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <h5>Carregando dados...</h5>
        <p class="text-muted">Por favor, aguarde</p>
    </div>
</div>

<!-- Dashboard Page -->
<div id="dashboard-page" class="page-container active">
    {% include 'embarcacoes/dashboard_content.html' %}
</div>

<!-- Histórico Page -->
<div id="historico-page" class="page-container">
    {% include 'embarcacoes/historico_content.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Sistema SPA (Single Page Application)
class ARITANASPA {
    constructor() {
        this.currentPage = 'dashboard';
        this.pages = {
            'dashboard': 'dashboard-page',
            'historico': 'historico-page'
        };
        this.isInitialized = false;
        this.init();
    }

    init() {
        // Aguarda o cache de navegação estar disponível
        if (window.navigationCache) {
            this.setupNavigation();
            this.loadInitialData();
        } else {
            // Aguarda o script carregar
            setTimeout(() => this.init(), 100);
        }
    }

    setupNavigation() {
        // Intercepta cliques na navbar
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const href = link.getAttribute('href');
                if (href === '/' || href.includes('dashboard')) {
                    this.navigateTo('dashboard');
                } else if (href.includes('historico')) {
                    this.navigateTo('historico');
                }
            });
        });
    }

    async navigateTo(pageName, pageNumber = 1) {
        if (this.currentPage === pageName && pageNumber === 1) {
            return; // Já está na página
        }

        this.showLoading();

        try {
            // Carrega dados se necessário
            const data = await window.navigationCache.loadData();

            // Atualiza navegação
            this.updateNavigation(pageName);
            
            // Mostra página
            this.showPage(pageName);

            // Atualiza conteúdo da página
            if (pageName === 'historico') {
                await this.updateHistoricoPage(data.embarcacoes, pageNumber);
            } else if (pageName === 'dashboard') {
                await this.updateDashboardPage(data.embarcacoes, data.estatisticas);
            }

            this.currentPage = pageName;

        } catch (error) {
            console.error('Erro na navegação:', error);
            this.showError('Erro ao carregar dados. Tente novamente.');
        } finally {
            this.hideLoading();
        }
    }

    updateNavigation(activePage) {
        // Remove classe active de todos os links
        document.querySelectorAll('.header-nav-link').forEach(link => {
            link.classList.remove('active');
        });

        // Adiciona classe active ao link atual
        const activeLink = document.querySelector(`[href*="${activePage}"]`) || 
                          document.querySelector(`[onclick*="${activePage}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }

    showPage(pageName) {
        // Esconde todas as páginas
        document.querySelectorAll('.page-container').forEach(page => {
            page.classList.remove('active');
        });

        // Mostra página atual
        const pageElement = document.getElementById(this.pages[pageName]);
        if (pageElement) {
            pageElement.classList.add('active');
        }
    }

    async updateDashboardPage(embarcacoes, estatisticas) {
        // Atualiza estatísticas
        this.updateDashboardStats(estatisticas);
        
        // Aguarda um pouco para garantir que a página está visível
        setTimeout(() => {
            // Usar função debounced para evitar múltiplas inicializações
            if (window.debouncedReinitialize) {
                console.log('Reinicializando dashboard com debounce...');
                window.debouncedReinitialize();
            } else if (window.safeReinitializeDashboard) {
                console.log('Reinicializando dashboard de forma segura...');
                window.safeReinitializeDashboard();
            } else {
                // Fallback para método anterior
                if (window.initializeMap) {
                    console.log('Reinicializando mapa...');
                    window.initializeMap();
                }
                
                if (window.initializeCharts) {
                    console.log('Reinicializando gráficos...');
                    window.initializeCharts();
                }
            }
            
            // Inicializar gráfico temporal separadamente
            if (window.initializeTemporalChart) {
                setTimeout(() => {
                    window.initializeTemporalChart();
                }, 500);
            }
            
            // Reinicializar outros componentes
            if (window.initializeUpload) {
                window.initializeUpload();
            }
            
            if (window.initializeTabs) {
                window.initializeTabs();
            }
        }, 300);
    }

    updateDashboardStats(estatisticas) {
        // Atualiza números das estatísticas
        const totalElement = document.querySelector('.stat-total');
        const legalElement = document.querySelector('.stat-legal');
        const illegalElement = document.querySelector('.stat-illegal');

        console.log('Atualizando estatísticas:', estatisticas);

        if (totalElement) {
            // Usar dados do Django se disponíveis, senão usar estatísticas da API
            const djangoTotal = {{ total_embarcacoes|default:0 }};
            const djangoLegal = {{ embarcacoes_legais|default:0 }};
            const djangoIllegal = {{ embarcacoes_ilegais|default:0 }};

            if (djangoTotal > 0) {
                // Usar dados do Django
                this.animateNumber(totalElement, djangoTotal);
                if (legalElement) this.animateNumber(legalElement, djangoLegal);
                if (illegalElement) this.animateNumber(illegalElement, djangoIllegal);
            } else if (estatisticas && estatisticas.legalidade) {
                // Usar dados da API como fallback
                const total = estatisticas.legalidade.legais + estatisticas.legalidade.ilegais;
                this.animateNumber(totalElement, total);
                if (legalElement) this.animateNumber(legalElement, estatisticas.legalidade.legais);
                if (illegalElement) this.animateNumber(illegalElement, estatisticas.legalidade.ilegais);
            }
        }
    }

    async updateHistoricoPage(embarcacoes, pageNumber) {
        const pageSize = 20;
        const startIndex = (pageNumber - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = embarcacoes.slice(startIndex, endIndex);

        // Atualiza tabela
        this.updateHistoricoTable(pageData);
        
        // Atualiza estatísticas
        this.updateHistoricoStats(embarcacoes);
        
        // Atualiza paginação
        this.updatePagination(embarcacoes.length, pageNumber, pageSize);
    }

    updateHistoricoTable(embarcacoes) {
        const tbody = document.querySelector('#tabela-embarcacoes tbody');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        embarcacoes.forEach(embarcacao => {
            const row = this.createHistoricoRow(embarcacao);
            tbody.appendChild(row);
        });
    }

    createHistoricoRow(embarcacao) {
        const row = document.createElement('tr');
        row.className = 'embarcacao-row';
        
        const classificacaoClass = embarcacao.classificacao.toLowerCase() === 'legal' ? 'bg-success' : 'bg-danger';
        const classificacaoText = embarcacao.classificacao.toLowerCase() === 'legal' ? '✅ Legal' : '⚠️ Ilegal';

        row.innerHTML = `
            <td><span class="fw-bold text-primary">#${embarcacao.id}</span></td>
            <td><strong>${embarcacao.localidade}</strong></td>
            <td><span class="badge badge-classificacao ${classificacaoClass}">${classificacaoText}</span></td>
            <td><span class="badge bg-info bg-opacity-75">${embarcacao.regiao}</span></td>
            <td>
                ${embarcacao.imagem_url ? 
                    `<button class="btn btn-sm btn-outline-info btn-action" onclick="verImagem('${embarcacao.imagem_url}', '${embarcacao.localidade}')">
                        <i class="fas fa-image"></i>
                    </button>` :
                    `<span class="text-muted"><i class="fas fa-ban"></i> N/A</span>`
                }
            </td>
            <td>
                <div class="coords-info">
                    <div><strong>Cadastro:</strong> ${new Date(embarcacao.data_cadastro).toLocaleString('pt-BR')}</div>
                    ${embarcacao.data_foto ? `<div><strong>Foto:</strong> ${new Date(embarcacao.data_foto).toLocaleString('pt-BR')}</div>` : ''}
                </div>
            </td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-primary btn-action" onclick="verDetalhes('${embarcacao.id}')">
                        <i class="fas fa-eye me-1"></i>Ver
                    </button>
                    <button class="btn btn-sm btn-info btn-action" onclick="verNoMapa('${embarcacao.id}')">
                        <i class="fas fa-map-marker-alt me-1"></i>Mapa
                    </button>
                </div>
            </td>
        `;

        return row;
    }

    updateHistoricoStats(embarcacoes) {
        const total = embarcacoes.length;
        const legais = embarcacoes.filter(e => e.classificacao.toLowerCase() === 'legal').length;
        const ilegais = embarcacoes.filter(e => e.classificacao.toLowerCase() === 'ilegal').length;

        this.animateNumber(document.getElementById('total-embarcacoes'), total);
        this.animateNumber(document.getElementById('embarcacoes-legais'), legais);
        this.animateNumber(document.getElementById('embarcacoes-ilegais'), ilegais);
    }

    updatePagination(totalItems, currentPage, pageSize) {
        const totalPages = Math.ceil(totalItems / pageSize);
        const paginationContainer = document.querySelector('.pagination');
        
        if (!paginationContainer) return;

        paginationContainer.innerHTML = '';

        // Botões de navegação
        if (currentPage > 1) {
            paginationContainer.appendChild(this.createPaginationButton('<<', 1, 'Primeira página'));
            paginationContainer.appendChild(this.createPaginationButton('<', currentPage - 1, 'Página anterior'));
        }

        // Números das páginas
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            const button = this.createPaginationButton(i, i, `Página ${i}`);
            if (i === currentPage) {
                button.classList.add('active');
            }
            paginationContainer.appendChild(button);
        }

        if (currentPage < totalPages) {
            paginationContainer.appendChild(this.createPaginationButton('>', currentPage + 1, 'Próxima página'));
            paginationContainer.appendChild(this.createPaginationButton('>>', totalPages, 'Última página'));
        }
    }

    createPaginationButton(text, page, title) {
        const li = document.createElement('li');
        li.className = 'page-item';
        
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = text;
        a.title = title;
        a.onclick = (e) => {
            e.preventDefault();
            this.navigateTo('historico', page);
        };
        
        li.appendChild(a);
        return li;
    }

    animateNumber(element, targetValue) {
        if (!element) return;
        
        const startValue = parseInt(element.textContent) || 0;
        const duration = 500;
        const startTime = Date.now();

        const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const currentValue = Math.round(startValue + (targetValue - startValue) * progress);
            
            element.textContent = currentValue;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        };

        animate();
    }

    async loadInitialData() {
        this.showLoading();
        
        try {
            // Carrega dados iniciais
            await window.navigationCache.loadData();
            
            // Atualiza página inicial com dados do contexto Django
            const djangoData = {
                embarcacoes: {{ dados_embarcacoes_json|safe }},
                estatisticas: {{ estatisticas_json|safe }}
            };
            
            // Se dados do Django estão disponíveis, usa eles
            if (djangoData.embarcacoes && djangoData.embarcacoes.length > 0) {
                await this.updateDashboardPage(
                    djangoData.embarcacoes,
                    djangoData.estatisticas
                );
            } else {
                // Senão, usa dados do cache
                await this.updateDashboardPage(
                    window.navigationCache.cache.embarcacoes,
                    window.navigationCache.cache.estatisticas
                );
            }
            
        } catch (error) {
            console.error('Erro ao carregar dados iniciais:', error);
        } finally {
            this.hideLoading();
        }
    }

    showLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.style.display = 'flex';
        }
    }

    hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '10000';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);

        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 5000);
    }
}

// Inicializa SPA quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', () => {
    window.aritanaSPA = new ARITANASPA();
    
    // Forçar atualização das estatísticas imediatamente
    setTimeout(() => {
        if (typeof window.loadStatsFromAPI === 'function') {
            window.loadStatsFromAPI();
        }
    }, 500);
    
    // Inicializar componentes do dashboard se estiver na página inicial
    setTimeout(() => {
        initializeDashboardComponents();
    }, 1000);
});

// Função global de navegação
window.navigateToPage = function(pageName, pageNumber = 1) {
    if (window.aritanaSPA) {
        window.aritanaSPA.navigateTo(pageName, pageNumber);
    }
};

// Função para atualizar estatísticas com dados do Django
function updateDashboardStatsFromDjango() {
    const totalElement = document.querySelector('.stat-total');
    const legalElement = document.querySelector('.stat-legal');
    const illegalElement = document.querySelector('.stat-illegal');

    if (totalElement) {
        const djangoTotal = {{ total_embarcacoes|default:0 }};
        if (djangoTotal > 0) {
            totalElement.textContent = djangoTotal;
        }
    }

    if (legalElement) {
        const djangoLegal = {{ embarcacoes_legais|default:0 }};
        if (djangoLegal > 0) {
            legalElement.textContent = djangoLegal;
        }
    }

    if (illegalElement) {
        const djangoIllegal = {{ embarcacoes_ilegais|default:0 }};
        if (djangoIllegal > 0) {
            illegalElement.textContent = djangoIllegal;
        }
    }
}

// Expor função globalmente
window.updateDashboardStatsFromDjango = updateDashboardStatsFromDjango;

// Inicializar componentes do dashboard
function initializeDashboardComponents() {
    // Atualizar estatísticas imediatamente
    if (typeof window.updateDashboardStatsFromDjango === 'function') {
        window.updateDashboardStatsFromDjango();
    }
    
    // Inicializar mapa
    if (typeof window.loadLeaflet === 'function') {
        window.loadLeaflet().then(() => {
            if (typeof window.initializeMap === 'function') {
                window.initializeMap();
            }
        });
    }
    
    // Inicializar gráficos
    if (typeof window.loadChartJS === 'function') {
        window.loadChartJS().then(() => {
            if (typeof window.initializeCharts === 'function') {
                window.initializeCharts();
            }
        });
    }
}
</script>
{% endblock %}
